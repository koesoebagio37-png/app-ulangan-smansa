<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Ujian (Secure) - Comfort & Glow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'cyber': { 900: '#02120a', 800: '#051f15', 700: '#064e3b', 500: '#10b981', 400: '#34d399' },
                        'soft': { bg: '#fdfbf7', card: '#ffffff', border: '#e8e6e1', text: '#4a4a4a', primary: '#6b7280' }
                    }
                }
            }
        }
    </script>
    <!-- MathJax -->
    <script>MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d6d3cf; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #064e3b; }
        .tab-btn.active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        .dark .tab-btn.active { color: #34d399; border-bottom: 2px solid #34d399; }
        
        /* Print Styles */
        @media print {
            body > *:not(#print-area) { display: none !important; }
            #print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; color: black; z-index: 9999; }
            
            @page { margin: 10mm; }

            .print-table { width: 100%; border-collapse: collapse; border: 1px solid black; table-layout: fixed; }
            .print-table th, .print-table td { border: 1px solid black; padding: 5px; vertical-align: top; word-wrap: break-word; overflow-wrap: break-word; }
            
            .layout-worksheet .col-no { width: 5%; font-size: 9pt; text-align: center; }
            .layout-worksheet .col-soal { width: 35%; font-size: 9pt; } 
            .layout-worksheet .col-jawab { width: 60%; } 
            
            .layout-compact .print-table { table-layout: fixed; }
            .layout-compact .col-no { width: 4%; font-size: 8pt; text-align: center; }
            .layout-compact .col-soal { width: 46%; font-size: 8pt; } 

            .layout-standard .col-no { width: 5%; text-align: center; }
            .layout-standard .col-soal { width: 95%; }

            .print-option { display: flex; align-items: start; gap: 4px; margin-bottom: 1px; }
            .print-option-key { font-weight: bold; text-decoration: underline; } 
            tr { page-break-inside: avoid; }
        }
        #print-area { display: none; }
    </style>
</head>
<body class="bg-soft-bg text-soft-text dark:bg-cyber-900 dark:text-emerald-50 transition-colors duration-500 flex flex-col h-screen overflow-hidden">

    <!-- LOGIN OVERLAY -->
    <!-- Default hidden, only shown via JS if no auth -->
    <div id="login-overlay" class="fixed inset-0 z-[100] bg-gray-100 dark:bg-cyber-900 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-cyber-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-emerald-900">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-indigo-100 dark:bg-emerald-900/50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">üîí</div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Login Admin</h2>
                <p class="text-gray-500 text-sm">Akses Manajemen Ujian</p>
            </div>
            <!-- Loading State for Auto Login -->
            <div id="login-loading" class="text-center hidden">
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="text-indigo-600 font-bold animate-pulse">Memverifikasi Sesi Dashboard...</p>
            </div>
            
            <!-- Manual Login Form -->
            <form id="admin-login-form" class="space-y-4 hidden">
                <p class="text-center text-red-500 text-sm font-bold">Silakan Login melalui Portal Akademik (Dashboard)</p>
                <button type="button" onclick="window.location.href='Portal Akademik.html'" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg">Ke Portal Akademik</button>
            </form>
            <p id="login-error-msg" class="text-red-500 text-center text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- Header -->
    <header class="flex-none bg-[#fdfbf7]/80 dark:bg-cyber-900/80 backdrop-blur-lg border-b border-soft-border dark:border-emerald-900 z-20 sticky top-0 transition-colors duration-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-100 dark:bg-emerald-900/50 p-2 rounded-lg border border-indigo-200 dark:border-emerald-500 shadow-sm">
                    <svg class="w-6 h-6 text-indigo-500 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-soft-text dark:text-emerald-50">
                        MANAJEMEN <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 dark:from-emerald-400 dark:to-teal-300">UJIAN</span>
                    </h1>
                    <p class="text-[12px] text-gray-400 italic">Connected: <span id="header-user-id">-</span></p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="user-badge" class="hidden md:flex items-center gap-2 bg-white dark:bg-cyber-800 px-3 py-1 rounded-full border border-gray-200 dark:border-emerald-800 shadow-sm">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="current-user-mapel" class="text-xs font-bold text-gray-600 dark:text-gray-300">Guest</span>
                </div>
                <button id="logout-btn" class="hidden bg-red-100 text-red-600 px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-200 transition-colors">Tutup</button>
                <button id="dark-mode-toggle" class="p-2 rounded-full bg-indigo-50 dark:bg-cyber-800 text-indigo-400 dark:text-emerald-400 hover:bg-indigo-100 dark:hover:bg-cyber-700 transition-all">üåô</button>
            </div>
        </div>
    </header>

    <!-- Navigasi Tab -->
    <div class="w-full bg-white dark:bg-cyber-800 border-b border-gray-200 dark:border-emerald-900 shadow-sm">
        <div class="flex justify-center max-w-5xl mx-auto">
            <button id="tab-buat" class="tab-btn active w-1/2 py-4 px-2 font-bold text-xs md:text-sm text-gray-500 hover:text-indigo-600 dark:text-emerald-500/60 dark:hover:text-emerald-300 transition-colors">BUAT UJIAN</button>
            <button id="tab-kelola" class="tab-btn w-1/2 py-4 px-2 font-bold text-xs md:text-sm text-gray-500 hover:text-indigo-600 dark:text-emerald-500/60 dark:hover:text-emerald-300 transition-colors">KELOLA AKTIF</button>
        </div>
    </div>

    <!-- Konten Utama -->
    <main class="flex-1 flex justify-center p-4 md:p-6 lg:p-8 overflow-y-auto relative">
        
        <!-- Tab 1: Buat Ujian -->
        <div id="tab-content-buat" class="main-container w-full max-w-5xl space-y-6">
            
            <div class="bg-white dark:bg-cyber-800 rounded-2xl shadow-sm border border-gray-200 dark:border-emerald-900 p-6">
                <h2 class="text-lg font-bold text-gray-700 dark:text-emerald-50 mb-4 flex items-center gap-2">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-indigo-100 dark:bg-emerald-900 text-indigo-600 dark:text-emerald-400 text-xs">1</span> Impor Soal
                </h2>
                <button id="impor-bank-soal-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    Buka Bank Soal (Firebase)
                </button>
            </div>

            <div class="bg-white dark:bg-cyber-800 rounded-2xl shadow-sm border border-gray-200 dark:border-emerald-900 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700 dark:text-emerald-50 flex items-center gap-2">
                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-indigo-100 dark:bg-emerald-900 text-indigo-600 dark:text-emerald-400 text-xs">2</span> Soal Terpilih (<span id="jumlah-soal-terpilih">0</span>)
                    </h2>
                    <div class="flex gap-2 items-center">
                        <button onclick="window.clearSelectedQuestions()" class="flex items-center gap-2 bg-red-50 hover:bg-red-100 text-red-600 dark:bg-red-900/20 dark:text-red-300 dark:hover:bg-red-900/40 px-3 py-1.5 rounded-lg border border-red-100 dark:border-red-800 text-xs font-bold shadow-sm transition-all" title="Hapus semua soal">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Bersihkan
                        </button>
                        
                        <button onclick="window.openPrintModal()" class="flex items-center gap-2 bg-sky-100 hover:bg-sky-200 text-sky-700 dark:bg-sky-900/30 dark:text-sky-300 px-3 py-1.5 rounded-lg border border-sky-200 dark:border-sky-800 text-xs font-bold shadow-sm"><span>üñ®Ô∏è</span> Mode Cetak</button>
                        <label class="flex items-center cursor-pointer bg-gray-100 dark:bg-emerald-900/30 px-3 py-1.5 rounded-full border border-gray-200 dark:border-emerald-800 hover:border-indigo-300 transition-all">
                            <span class="mr-2 text-xs font-bold text-gray-600 dark:text-emerald-400">Auto Bobot</span>
                            <input type="checkbox" id="toggle-auto-bobot" class="sr-only peer" onchange="renderSoalTerpilih()">
                            <div class="relative w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:bg-indigo-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div>
                        </label>
                    </div>
                </div>
                <div id="soal-terpilih-container" class="space-y-4 max-h-[600px] overflow-y-auto p-1 bg-transparent min-h-[100px]">
                    <div class="text-center text-gray-400 py-8 italic">Belum ada soal dipilih.</div>
                </div>
                <div class="mt-4 text-right text-sm font-bold text-gray-600 dark:text-emerald-400 p-2 bg-gray-50 dark:bg-cyber-900 rounded-lg">Total Poin: <span id="total-bobot-display" class="text-lg text-indigo-600 dark:text-emerald-300">0</span></div>
            </div>

            <div class="bg-white dark:bg-cyber-800 rounded-2xl shadow-sm border border-gray-200 dark:border-emerald-900 p-6">
                <h2 class="text-lg font-bold text-gray-700 dark:text-emerald-50 mb-4 flex items-center gap-2">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-indigo-100 dark:bg-emerald-900 text-indigo-600 dark:text-emerald-400 text-xs">3</span> Pengaturan Ujian
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="exam-name" class="w-full bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-lg p-3 text-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nama Ujian">
                    
                    <!-- UPDATE: Input Target Kelas dengan Datalist -->
                    <div class="relative">
                         <input list="list-kelas-ampu" type="text" id="exam-target-class" class="w-full bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-lg p-3 text-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Target Kelas (Cth: X-1, X-2)">
                         <datalist id="list-kelas-ampu">
                             <!-- Will be populated by JS based on Teacher's Classes -->
                         </datalist>
                         <p class="text-[10px] text-gray-400 mt-1">*Pisahkan dengan koma jika banyak. Gunakan dropdown untuk saran kelas Anda.</p>
                    </div>
                </div>
                <div class="flex items-center mb-4">
                    <input id="target-all-class" type="checkbox" class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                    <label for="target-all-class" class="ml-2 text-sm text-gray-600 dark:text-gray-300">Untuk Semua Kelas</label>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <input type="number" id="exam-duration" class="p-3 bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-lg outline-none text-gray-700 dark:text-white" placeholder="Durasi (Menit)">
                    <input type="number" id="exam-max-cheat" class="p-3 bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-lg outline-none text-gray-700 dark:text-white" placeholder="Max Curang" value="3">
                    <input type="text" id="exam-pin-reset" class="p-3 bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-lg outline-none text-gray-700 dark:text-white" placeholder="PIN Reset Guru">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 dark:bg-cyber-900/50 p-4 rounded-xl border border-gray-100 dark:border-emerald-800">
                    <div class="space-y-3">
                        <label class="flex items-center cursor-pointer"><input id="setting-acak-soal" type="checkbox" class="w-4 h-4 text-indigo-600 rounded" checked> <span class="ml-2 text-sm dark:text-gray-300">Acak Soal</span></label>
                        <label class="flex items-center cursor-pointer"><input id="setting-acak-opsi" type="checkbox" class="w-4 h-4 text-indigo-600 rounded" checked> <span class="ml-2 text-sm dark:text-gray-300">Acak Opsi</span></label>
                        <label class="flex items-center cursor-pointer"><input id="setting-batasi-satu-kali" type="checkbox" class="w-4 h-4 text-red-500 rounded" checked> <span class="ml-2 text-sm font-bold text-red-600 dark:text-red-400">Batasi 1x Login</span></label>
                    </div>
                    <div class="space-y-3">
                        <label class="flex items-center cursor-pointer"><input id="setting-tampil-nilai" type="checkbox" class="w-4 h-4 text-indigo-600 rounded"> <span class="ml-2 text-sm font-bold text-indigo-600 dark:text-indigo-400">Tampilkan Nilai</span></label>
                        <div id="container-kunci" class="ml-6 opacity-50 pointer-events-none transition-all">
                            <label class="flex items-center cursor-pointer"><input id="setting-tampil-kunci" type="checkbox" class="w-4 h-4 text-indigo-600 rounded"> <span class="ml-2 text-sm text-gray-600 dark:text-gray-300">Buka Kunci & Pembahasan</span></label>
                        </div>
                    </div>
                </div>
            </div>

            <button id="publish-exam-btn" class="w-full bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition-all hover:-translate-y-1 text-lg tracking-wide">üöÄ PUBLIKASIKAN UJIAN (ONLINE)</button>
        </div>

        <!-- Tab 2: Kelola Aktif -->
        <div id="tab-content-kelola" class="hidden main-container w-full max-w-4xl space-y-6">
             <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                 <h2 class="text-xl font-bold text-gray-800 dark:text-white">Daftar Ujian Aktif</h2>
                 <div class="flex gap-2 w-full md:w-auto">
                     <select id="filter-kelola-kelas" class="bg-white dark:bg-cyber-900 border border-gray-300 dark:border-emerald-800 text-gray-700 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full md:w-auto p-2.5">
                        <option value="">Semua Kelas</option>
                        <!-- Opsi akan diisi otomatis -->
                     </select>
                     <button id="fetch-active-exams-btn" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg font-bold hover:bg-indigo-200 transition-colors">Refresh</button>
                 </div>
             </div>
             <div id="active-exam-list" class="space-y-4"></div>
        </div>

    </main>

    <!-- PRINT AREA -->
    <div id="print-area"></div>

    <!-- MODAL IMPOR SOAL -->
    <div id="impor-soal-modal" class="fixed inset-0 z-50 hidden bg-gray-900/80 backdrop-blur-sm overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white dark:bg-cyber-800 w-full max-w-5xl rounded-2xl shadow-2xl border border-gray-200 dark:border-emerald-900 flex flex-col max-h-[85vh]">
                <div class="p-4 border-b border-gray-200 dark:border-emerald-800 flex justify-between items-center bg-gray-50 dark:bg-cyber-900">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white">Bank Soal (Firebase)</h3>
                    <button id="close-impor-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="p-4 border-b border-gray-200 dark:border-emerald-800 bg-white dark:bg-cyber-800">
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-2 mb-3">
                        <select id="filter-mapel" class="bg-gray-50 border rounded text-xs p-2 dark:bg-cyber-900 dark:border-emerald-800 dark:text-white"><option value="">Semua Mapel</option></select>
                        <select id="filter-kelas" class="bg-gray-50 border rounded text-xs p-2 dark:bg-cyber-900 dark:border-emerald-800 dark:text-white"><option value="">Semua Kelas</option></select>
                        <select id="filter-tipe" class="bg-gray-50 border rounded text-xs p-2 dark:bg-cyber-900 dark:border-emerald-800 dark:text-white"><option value="">Semua Tipe</option></select>
                        <select id="filter-kesulitan" class="bg-gray-50 border rounded text-xs p-2 dark:bg-cyber-900 dark:border-emerald-800 dark:text-white"><option value="">Semua Level</option></select>
                        <select id="filter-bab" class="bg-gray-50 border rounded text-xs p-2 dark:bg-cyber-900 dark:border-emerald-800 dark:text-white"><option value="">Semua BAB</option></select>
                        <select id="filter-subbab" class="bg-gray-50 border rounded text-xs p-2 dark:bg-cyber-900 dark:border-emerald-800 dark:text-white"><option value="">Semua Sub</option></select>
                    </div>
                    <button id="search-firebase-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg text-sm">Cari / Refresh Soal</button>
                </div>
                <div id="filter-results-container" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50 dark:bg-cyber-900/50">
                    <div class="text-center text-gray-400 py-10">Silakan pilih filter dan tekan tombol Cari untuk menampilkan soal.</div>
                </div>
                <div class="p-4 border-t border-gray-200 dark:border-emerald-800 bg-white dark:bg-cyber-800 flex justify-between items-center">
                    <button id="select-all-btn" class="text-sm text-indigo-600 font-bold hover:underline">Pilih Semua</button>
                    <button id="import-selected-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg">Tambahkan Terpilih</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL KONFIGURASI PRINT -->
    <div id="print-config-modal" class="fixed inset-0 z-[70] hidden bg-gray-900/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Konfigurasi Cetak (Offline)</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Judul Ujian di Kertas</label>
                    <input type="text" id="print-title" class="w-full border rounded p-2 text-gray-800" placeholder="Contoh: ULANGAN HARIAN MTK">
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Ukuran Kertas</label>
                    <select id="print-paper" class="w-full border rounded p-2 text-gray-800 bg-white">
                        <option value="f4">F4 / Folio (21.5cm x 33cm)</option>
                        <option value="a4">A4 (21cm x 29.7cm)</option>
                        <option value="letter">Letter / Kuarto</option>
                        <option value="legal">Legal</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Pilih Layout</label>
                    <select id="print-layout" class="w-full border rounded p-2 text-gray-800 bg-white" onchange="toggleCustomWidthSlider()">
                        <option value="worksheet">Layout Lembar Jawab (3 Kolom)</option>
                        <option value="standard">Layout Standar (Hemat Kertas)</option>
                        <option value="compact">Layout Super Hemat (2 Kolom)</option>
                    </select>
                    
                    <div id="custom-width-container" class="mt-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Atur Lebar Kolom Soal:</label>
                        <input type="range" id="column-width-slider" min="20" max="80" value="35" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Kecil (20%)</span>
                            <span id="width-value-display" class="font-bold text-indigo-600">35%</span>
                            <span>Besar (80%)</span>
                        </div>
                    </div>

                    <p class="text-xs text-gray-500 mt-2">
                        <span id="layout-desc-worksheet">Mode ini menampilkan kolom kosong untuk jawaban siswa. Geser slider untuk mengatur lebar area soal.</span>
                        <span id="layout-desc-compact" class="hidden">Mode ini membagi kertas jadi 2 kolom (Kiri & Kanan) dengan font lebih kecil.</span>
                    </p>
                </div>

                <div>
                    <label class="flex items-center gap-2 cursor-pointer mt-2">
                        <input type="checkbox" id="print-with-key" class="w-5 h-5 text-indigo-600">
                        <span class="text-gray-700 font-medium">Cetak Sebagai Pegangan Guru (Kunci Jawaban)</span>
                    </label>
                    <p class="text-xs text-gray-500 ml-7 mt-1">Jika dicentang, jawaban benar akan ditandai.</p>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('print-config-modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-bold">Batal</button>
                <button onclick="window.executePrint()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    Print Sekarang
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL SUCCESS -->
    <div id="publish-success-modal" class="fixed inset-0 z-[60] hidden bg-gray-900/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-cyber-800 w-full max-w-md rounded-2xl p-8 text-center border-t-4 border-green-500 shadow-2xl">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Ujian Terbit!</h3>
            <div id="exam-code-display" class="text-5xl font-mono font-bold text-indigo-600 dark:text-emerald-400 tracking-widest mb-8 select-all bg-gray-50 dark:bg-cyber-900 py-4 rounded-xl border border-dashed border-indigo-300 dark:border-emerald-700">------</div>
            <button onclick="document.getElementById('publish-success-modal').classList.add('hidden')" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-xl">Tutup</button>
        </div>
    </div>

    <!-- TOAST NOTIFIKASI -->
    <div id="notification-toast" class="fixed top-6 right-6 z-[100] hidden transition-all duration-300 transform translate-x-full"></div>

    <!-- MODAL PREVIEW SOAL -->
    <div id="preview-soal-modal" class="fixed inset-0 z-[80] hidden bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-cyber-800 w-full max-w-2xl rounded-2xl shadow-2xl border border-gray-200 dark:border-emerald-900 flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-gray-200 dark:border-emerald-800 flex justify-between items-center bg-gray-50 dark:bg-cyber-900 rounded-t-2xl">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">Preview Soal</h3>
                <button onclick="document.getElementById('preview-soal-modal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
            </div>
            <div id="preview-soal-content" class="p-6 overflow-y-auto text-gray-800 dark:text-gray-200">
            </div>
        </div>
    </div>

    <!-- MODAL DEEP EDIT -->
    <div id="deep-edit-modal" class="fixed inset-0 z-[90] hidden bg-gray-900/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-cyber-800 w-full max-w-4xl rounded-2xl shadow-2xl border border-gray-200 dark:border-emerald-900 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-200 dark:border-emerald-800 flex justify-between items-center bg-indigo-600 rounded-t-2xl">
                <h3 class="text-lg font-bold text-white">Edit Detail Soal</h3>
                <button onclick="document.getElementById('deep-edit-modal').classList.add('hidden')" class="text-white hover:text-red-200 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1 space-y-4">
                <input type="hidden" id="deep-edit-index">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Naskah Soal</label>
                        <textarea id="deep-edit-naskah" class="w-full h-32 p-3 border rounded-lg bg-gray-50 dark:bg-black/20 dark:text-white focus:ring-2 focus:ring-indigo-500" placeholder="Tulis soal..."></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Tipe Soal</label>
                        <select id="deep-edit-type" class="w-full p-3 border rounded-lg bg-gray-50 dark:bg-black/20 dark:text-white mb-4">
                            <option value="pg">Pilihan Ganda (PG)</option>
                            <option value="pgk">Pilihan Ganda Kompleks (PGK)</option>
                            <option value="bs">Benar - Salah</option>
                            <option value="esai-singkat">Isian Singkat</option>
                            <option value="esai-kompleks">Uraian / Esai</option>
                        </select>
                        
                        <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 rounded text-xs text-yellow-800 dark:text-yellow-200">
                            <strong>Perhatian:</strong>
                            <ul class="list-disc ml-4 mt-1">
                                <li>Mode "Update Asli" akan mengubah soal di Bank Soal Firebase.</li>
                                <li>Semua ujian yang menggunakan soal ini akan ikut berubah.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="border-t pt-4 border-gray-200 dark:border-emerald-800">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-gray-500">Opsi Jawaban & Kunci</label>
                        <button id="btn-add-deep-opt" onclick="window.addDeepEditOption()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 font-bold">+ Tambah Opsi</button>
                    </div>
                    <div id="deep-edit-options-list" class="space-y-2 max-h-60 overflow-y-auto p-1"></div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-200 dark:border-emerald-800 bg-gray-50 dark:bg-cyber-900 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.saveDeepEdit('new')" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-sm shadow-lg">Simpan Sebagai Soal Baru</button>
                <button onclick="window.saveDeepEdit('update')" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold text-sm shadow-lg">Update Soal Asli (Bahaya)</button>
            </div>
        </div>
    </div>
	
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, deleteDoc, getDocs, query, where, serverTimestamp, updateDoc, runTransaction, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwIwimlyrE4qQqYa2gA8Pfygd59USsveQ",
            authDomain: "aplikasi-ulangan-01.firebaseapp.com",
            projectId: "aplikasi-ulangan-01",
            storageBucket: "aplikasi-ulangan-01.firebasestorage.app",
            messagingSenderId: "409085062439",
            appId: "1:409085062439:web:280589d1a3e12e7b980d02",
        };

        let db, auth;
        // GLOBAL VARIABLES UNTUK USER ID (KABEL UTAMA)
        let currentGuruId = null;
        let currentGuruMapel = null;
        let currentGuruKelas = []; 
        let allActiveExams = []; // Cache for Active Exams
        
        let bankSoalCollectionRef, ujianTerjadwalCollectionRef;
        let tempBankSoalResults = [], soalTerpilihUntukUjian = [];
        let babSubBabMap = {}; 

        const showNotification = (msg, isError = false) => {
            const toast = document.getElementById('notification-toast');
            toast.textContent = msg;
            toast.className = `fixed top-6 right-6 z-[100] max-w-md p-4 rounded-xl shadow-lg transform transition-all duration-300 backdrop-blur-md border flex items-center gap-3 font-medium ${isError ? 'bg-red-100 border-red-300 text-red-800' : 'bg-white border-gray-200 text-green-800'}`;
            toast.classList.remove('hidden', 'translate-x-[150%]');
            setTimeout(() => toast.classList.add('translate-x-[150%]'), 3000);
        };

        // --- GLOBAL PRINT FUNCTIONS ---
        window.openPrintModal = () => {
            if(soalTerpilihUntukUjian.length === 0) return alert("Pilih soal terlebih dahulu sebelum mencetak.");
            
            const inputTitle = document.getElementById('exam-name').value;
            if(inputTitle) document.getElementById('print-title').value = inputTitle.toUpperCase();
            
            document.getElementById('print-config-modal').classList.remove('hidden');
        };
        
        window.clearSelectedQuestions = () => {
            if(confirm("Yakin ingin menghapus semua soal terpilih?")) {
                soalTerpilihUntukUjian = [];
                window.renderSoalTerpilih();
            }
        };

        // --- SLIDER LOGIC ---
        window.toggleCustomWidthSlider = () => {
            const layout = document.getElementById('print-layout').value;
            const sliderContainer = document.getElementById('custom-width-container');
            const descWorksheet = document.getElementById('layout-desc-worksheet');
            const descCompact = document.getElementById('layout-desc-compact');
            
            if(layout === 'worksheet') {
                sliderContainer.classList.remove('hidden');
                descWorksheet.classList.remove('hidden');
                descCompact.classList.add('hidden');
            } else {
                sliderContainer.classList.add('hidden');
                descWorksheet.classList.add('hidden');
                descCompact.classList.remove('hidden');
                if(layout === 'compact') {
                     descCompact.classList.remove('hidden');
                } else {
                     descCompact.classList.add('hidden');
                }
            }
        };

        document.getElementById('column-width-slider').addEventListener('input', (e) => {
            document.getElementById('width-value-display').textContent = e.target.value + '%';
        });

        window.executePrint = async () => {
            const printArea = document.getElementById('print-area');
            const title = document.getElementById('print-title').value || "UJIAN OFFLINE";
            const withKey = document.getElementById('print-with-key').checked;
            const layoutMode = document.getElementById('print-layout').value;
            const paperSize = document.getElementById('print-paper').value; 
            const targetClass = document.getElementById('exam-target-class').value || '';
            const duration = document.getElementById('exam-duration').value || '';
            const jumlahSoal = soalTerpilihUntukUjian.length;

            let sizeCss = 'A4';
            if (paperSize === 'f4') sizeCss = '215mm 330mm'; 
            else if (paperSize === 'letter') sizeCss = 'letter';
            else if (paperSize === 'legal') sizeCss = 'legal';
            
            let styleTag = document.getElementById('dynamic-page-size');
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'dynamic-page-size';
                document.head.appendChild(styleTag);
            }
            styleTag.innerHTML = `@page { size: ${sizeCss}; margin: 10mm; }`;

            
            let minHeightRow = "auto";
            if(jumlahSoal <= 5 && jumlahSoal > 0) {
                const heightPerItem = Math.floor(220 / jumlahSoal); 
                minHeightRow = `${heightPerItem}mm`;
            }

            const customWidthSoal = document.getElementById('column-width-slider').value;
            const customWidthJawab = 95 - parseInt(customWidthSoal); 
            
            const paperSizeValue = document.getElementById('print-paper').value;
            let sizeString = 'A4'; 
            if(paperSizeValue === 'f4') sizeString = '215mm 330mm';
            else if(paperSizeValue === 'legal') sizeString = 'legal';
            else if(paperSizeValue === 'letter') sizeString = 'letter';

            let styleEl = document.getElementById('page-size-style');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'page-size-style';
                document.head.appendChild(styleEl);
            }
            
            let customStyle = `
                <style>
                    @media print {
                        @page { size: ${sizeString}; margin: 10mm; }
                        
                        .layout-worksheet .col-soal { width: ${customWidthSoal}% !important; }
                        .layout-worksheet .col-jawab { width: ${customWidthJawab}% !important; }
                    }
                </style>
            `;
            
            document.body.className = document.body.className.replace(/layout-\w+/g, '').replace(/paper-\w+/g, '');
            document.body.classList.add('layout-' + layoutMode);

            let html = customStyle;

            if (layoutMode === 'standard' || layoutMode === 'compact') {
                      html += `
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid black; margin-bottom: 20px;">
                        <tr>
                            <td style="width: 30%; border: 1px solid black; padding: 5px; vertical-align: top;">
                                <table style="width: 100%; font-size: 9pt;">
                                    <tr><td style="width: 50px;">Nama</td><td style="width: 10px;">:</td><td style="border-bottom: 1px solid #ccc;"></td></tr>
                                    <tr><td>Kelas</td><td>:</td><td><strong>${targetClass}</strong></td></tr>
                                    <tr><td>Waktu</td><td>:</td><td><strong>${duration} Menit</strong></td></tr>
                                </table>
                            </td>
                            <td style="width: 50%; border: 1px solid black; text-align: center; font-weight: bold; font-size: 14pt; vertical-align: middle; padding: 5px;">
                                ${title}
                            </td>
                            <td style="width: 20%; border: 1px solid black; text-align: center; vertical-align: top; padding-top: 5px;">
                                <span style="font-size: 10pt; font-weight: bold;">Nilai :</span>
                                <div style="height: 40px;"></div>
                            </td>
                        </tr>
                    </table>

                    <table class="print-table">
                        <thead>
                            <tr>
                                <th class="col-no" style="border: 1px solid black;">NO</th>
                                <th class="col-soal" style="border: 1px solid black;">SOAL</th>
                                ${layoutMode === 'compact' ? '<th class="col-no" style="border: 1px solid black;">NO</th><th class="col-soal" style="border: 1px solid black;">SOAL</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                    `;
                } else {
                    html += `
                    <table class="print-table" style="margin-bottom: 15px; border: 1px solid black;">
                        <tr>
                            <td width="40%" style="padding: 4px;">
                                <table style="width: 100%; border: none;">
                                    <tr style="border-bottom: 1px solid black;"> 
                                        <td style="border: none; width: 50px; padding: 2px;">Nama</td>
                                        <td style="border: none; width: 10px; padding: 2px;">:</td>
                                        <td style="border: none; padding: 2px;"></td> 
                                    </tr>
                                    <tr style="border-bottom: 1px solid black;"> 
                                        <td style="border: none; width: 50px; padding: 2px;">Kelas</td>
                                        <td style="border: none; width: 10px; padding: 2px;">:</td>
                                        <td style="border: none; padding: 2px;"><strong>${targetClass}</strong></td>
                                    </tr>
                                    <tr>
                                        <td style="border: none; width: 50px; padding: 2px;">Waktu</td>
                                        <td style="border: none; width: 10px; padding: 2px;">:</td>
                                        <td style="border: none; padding: 2px;"><strong>${duration ? duration + ' Menit' : ''}</strong></td>
                                    </tr>
                                </table>
                            </td>
                            <td width="45%" style="text-align:center; font-weight:bold; font-size: 14pt; vertical-align: middle; padding: 5px;">
                                ${title}
                            </td>
                            <td width="15%" style="text-align:center; vertical-align: top; padding-top: 10px; font-weight:bold;">
                                Nilai :
                            </td>
                        </tr>
                    </table>

                    <table class="print-table">
                        <thead>
                            <tr>
                                <th class="col-no">NO</th>
                                <th class="col-soal">SOAL</th>
                                <th class="col-jawab">JAWABAN / PENYELESAIAN</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                }

                const getQuestionHtml = (s, idx) => {
                    let opsiHtml = "";
                    if(s.type === 'pg' || s.type === 'pgk' || s.type === 'bs') {
                        const charLimit = layoutMode === 'worksheet' ? 20 : 60; 
                        
                        const isShortText = s.opsi.every(o => (o.text || '').length < charLimit);
                        const hasImages = s.opsi.some(o => o.imageBase64);
                        const useTwoColumns = isShortText && !hasImages && s.opsi.length >= 4;

                        opsiHtml += `<div style="margin-top: 5px;">`;

                        if (useTwoColumns) {
                            opsiHtml += `<div style="display: flex; gap: 15px;">`;
                            opsiHtml += `<div style="flex: 1;">`; 
                            s.opsi.slice(0, 3).forEach((opt, optIdx) => {
                            opsiHtml += renderPrintOption(opt, optIdx, s.type, s.kunci, withKey);
                            });
                            opsiHtml += `</div><div style="flex: 1;">`; 
                            s.opsi.slice(3).forEach((opt, optIdx) => {
                            opsiHtml += renderPrintOption(opt, optIdx+3, s.type, s.kunci, withKey);
                            });
                            opsiHtml += `</div></div>`;
                        } else {
                            (s.opsi || []).forEach((opt, optIdx) => {
                            opsiHtml += renderPrintOption(opt, optIdx, s.type, s.kunci, withKey);
                            });
                        }
                        opsiHtml += `</div>`;
                    }

                    if (withKey && s.type === 'esai-singkat') {
                        opsiHtml += `<div style="margin-top:10px; font-weight:bold;">Kunci: ${s.kunci}</div>`;
                    }

                    let imgHtml = s.naskahImage ? `<img src="${s.naskahImage}" style="max-height:150px; display:block; margin:5px 0;">` : '';
                    
                    return `
                        ${s.naskah}
                        ${imgHtml}
                        ${opsiHtml}
                    `;
                };

                if (layoutMode === 'compact') {
                    for (let i = 0; i < jumlahSoal; i += 2) {
                        const s1 = soalTerpilihUntukUjian[i];
                        const s2 = soalTerpilihUntukUjian[i+1];
                        
                        html += `<tr>`;
                        html += `<td class="col-no" style="text-align:center; border: 1px solid black;">${i+1}</td>`;
                        html += `<td class="col-soal" style="border: 1px solid black;">${getQuestionHtml(s1, i)}</td>`;
                        
                        if (s2) {
                            html += `<td class="col-no" style="text-align:center; border: 1px solid black;">${i+2}</td>`;
                            html += `<td class="col-soal" style="border: 1px solid black;">${getQuestionHtml(s2, i+1)}</td>`;
                        } else {
                            html += `<td class="col-no" style="border: 1px solid black;"></td><td class="col-soal" style="border: 1px solid black;"></td>`;
                        }
                        html += `</tr>`;
                    }
                } else {
                    soalTerpilihUntukUjian.forEach((s, i) => {
                        html += `<tr>`;
                        html += `<td class="col-no" style="text-align:center; border: 1px solid black;">${i+1}</td>`;
                        html += `<td class="col-soal" style="border: 1px solid black;">
                                    ${getQuestionHtml(s, i)}
                                </td>`;
                        if (layoutMode === 'worksheet') {
                            html += `<td class="col-jawab" style="height: ${minHeightRow}; border: 1px solid black;"></td>`;
                        }
                        html += `</tr>`;
                    });
                }

                html += `</tbody></table>`;
                printArea.innerHTML = html;

                document.getElementById('print-config-modal').classList.add('hidden');
                if(window.MathJax) {
                    await MathJax.typesetPromise([printArea]);
                }
                window.print();
            };

            function renderPrintOption(opt, idx, type, key, withKey) {
                let isCorrect = false;
                if(withKey && key !== undefined) {
                    if(type === 'pg') isCorrect = (key == idx);
                    else if(type === 'pgk' && Array.isArray(key)) isCorrect = key.includes(idx);
                    else if(type === 'bs' && Array.isArray(key)) isCorrect = (key[idx] === "true" || key[idx] === true);
                }
                const label = String.fromCharCode(65+idx) + ".";
                const keyStyle = isCorrect ? "print-option-key" : "";
                const checkMark = isCorrect ? " (‚úî)" : "";

                return `
                    <div class="print-option">
                        <b>${label}</b>
                        <span class="${keyStyle}">${opt.text || ''} ${checkMark}</span>
                    </div>
                `;
            }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // --- INJEKSI START: LOGIKA AUTO LOGIN (LocalStorage dari Dashboard) ---
                onAuthStateChanged(auth, (user) => {
                    const overlay = document.getElementById('login-overlay');
                    const logoutBtn = document.getElementById('logout-btn');
                    const loadingDiv = document.getElementById('login-loading');
                    const formDiv = document.getElementById('admin-login-form');
                    const userBadge = document.getElementById('user-badge');
                    
                    // 1. Cek Token Mapel dari LocalStorage (diset oleh Dashboard)
                    const tokenMapel = localStorage.getItem('cbt_user_mapel');
                    // AMBIL ID GURU & KELAS UNTUK LOGIKA ISOLASI
                    currentGuruId = localStorage.getItem('cbt_user_id');
                    try {
                        currentGuruKelas = JSON.parse(localStorage.getItem('cbt_user_kelas') || '[]');
                    } catch(e) { currentGuruKelas = []; }

                    currentGuruMapel = tokenMapel;

                    // 2. Cek apakah user sudah login di Firebase (Email/Pass atau Anonymous)
                    const isLoggedIn = user !== null;
                    
                    // 3. LOGIKA UTAMA
                    if (isLoggedIn) {
                        // === USER SUDAH AUTH ===
                        
                        // Setup Referensi Database
                        bankSoalCollectionRef = collection(db, 'bank_soal');
                        ujianTerjadwalCollectionRef = collection(db, 'ujian_terjadwal');
                        
                        // Buka Akses
                        overlay.classList.add('hidden');
                        logoutBtn.classList.remove('hidden');
                        
                        // Tampilkan Badge User
                        if(tokenMapel) {
                            document.getElementById('current-user-mapel').textContent = tokenMapel;
                            document.getElementById('header-user-id').textContent = currentGuruId || 'Unknown';
                            userBadge.classList.remove('hidden');
                        }

                        // --- POPULASI DATALIST KELAS UNTUK GURU ---
                        const datalistKelas = document.getElementById('list-kelas-ampu');
                        datalistKelas.innerHTML = '';
                        if (currentGuruKelas && currentGuruKelas.length > 0) {
                            currentGuruKelas.forEach(k => {
                                const opt = document.createElement('option');
                                opt.value = k;
                                datalistKelas.appendChild(opt);
                            });
                        }

                    } else if (tokenMapel) {
                        // === USER BELUM AUTH, TAPI ADA TOKEN DARI DASHBOARD ===
                        overlay.classList.remove('hidden');
                        formDiv.classList.add('hidden'); // Sembunyikan form
                        loadingDiv.classList.remove('hidden'); // Tampilkan loading

                        // Login Anonymous agar bisa akses Firestore
                        signInAnonymously(auth).catch(e => {
                            console.error("Auto-login gagal:", e);
                            loadingDiv.classList.add('hidden');
                            formDiv.classList.remove('hidden');
                            alert("Gagal login otomatis. Silakan gunakan email manual.");
                        });
                    } else {
                        // === TIDAK ADA TOKEN & TIDAK LOGIN ===
                        // Tampilkan Form Login Manual
                        overlay.classList.remove('hidden');
                        formDiv.classList.remove('hidden');
                        loadingDiv.classList.add('hidden');
                        logoutBtn.classList.add('hidden');
                    }
                });
                // --- INJEKSI END ---

                document.getElementById('logout-btn').addEventListener('click', () => {
                    if(confirm("Tutup aplikasi Admin dan kembali ke Dashboard?")) {
                        window.close();
                        setTimeout(() => { window.location.href = 'Portal Akademik.html'; }, 500);
                    }
                });
            } catch (e) { alert('Error Init: ' + e.message); }

            // Tabs
            const tabs = { buat: document.getElementById('tab-buat'), kelola: document.getElementById('tab-kelola') };
            const contents = { buat: document.getElementById('tab-content-buat'), kelola: document.getElementById('tab-content-kelola') };
            tabs.buat.addEventListener('click', () => { tabs.buat.classList.add('active'); tabs.kelola.classList.remove('active'); contents.buat.classList.remove('hidden'); contents.kelola.classList.add('hidden'); });
            tabs.kelola.addEventListener('click', () => { tabs.kelola.classList.add('active'); tabs.buat.classList.remove('active'); contents.kelola.classList.remove('hidden'); contents.buat.classList.add('hidden'); });

            // Dark Mode
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
            document.getElementById('dark-mode-toggle').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            });

            // --- VARIABEL GLOBAL & HELPER FILTER CERDAS (FIXED) ---
            let cachedBankSoal = []; 

            // Helper: Sort Kelas Romawi
            const sortKelasRomawi = (a, b) => {
                const romans = { 'SD':0, '1':1, '2':2, '3':3, '4':4, '5':5, '6':6, 'VII':7, 'VIII':8, 'IX':9, 'X':10, 'XI':11, 'XII':12, 'UMUM':99 };
                const valA = romans[a.replace(/Kelas/i, '').trim().toUpperCase()] || 99;
                const valB = romans[b.replace(/Kelas/i, '').trim().toUpperCase()] || 99;
                return valA - valB;
            };

            const getSubBab = (meta) => meta?.subbab || meta?.subBab || meta?.SubBab;

            // --- LOGIKA UPDATE DROPDOWN (CASCADING) ---
            function updateSmartFilters(triggerSource) {
                const fMapel = document.getElementById('filter-mapel');
                const fKelas = document.getElementById('filter-kelas');
                const fBab = document.getElementById('filter-bab');
                const fSub = document.getElementById('filter-subbab');
                
                const selMapel = fMapel.value;
                const selKelas = fKelas.value;
                const selBab = fBab.value;
                const selSub = fSub.value;

                // 1. Filter Data di Memori
                const mapelSet = new Set(cachedBankSoal.map(d => d.metadata?.mapel).filter(Boolean));
                const validForKelas = cachedBankSoal.filter(d => !selMapel || d.metadata?.mapel === selMapel);
                const kelasSet = new Set(validForKelas.map(d => d.metadata?.kelas).filter(Boolean));
                const validForBab = validForKelas.filter(d => !selKelas || d.metadata?.kelas === selKelas);
                const babSet = new Set(validForBab.map(d => d.metadata?.bab).filter(Boolean));
                const validForSub = validForBab.filter(d => !selBab || d.metadata?.bab === selBab);
                const subSet = new Set(validForSub.map(d => getSubBab(d.metadata)).filter(Boolean));

                // 2. Fungsi Render Dropdown
                const renderOpts = (el, set, currentVal, sorter = null) => {
                    let items = Array.from(set);
                    if(sorter) items.sort(sorter); else items.sort();

                    const isStillValid = items.includes(currentVal);
                    
                    const defaultText = el.options[0] ? el.options[0].text.replace(/-- | --/g, '') : "Pilih";
                    el.innerHTML = `<option value="">${defaultText}</option>`; 
                    
                    items.forEach(v => {
                        const opt = document.createElement('option');
                        opt.value = v;
                        opt.textContent = v;
                        el.appendChild(opt);
                    });

                    if (isStillValid) el.value = currentVal;
                    else el.value = "";
                };

                // 3. Eksekusi Render
                // PENTING: Jangan render ulang Mapel jika sudah terkunci via Dashboard
                const userMapel = currentGuruMapel;
                const isMapelLocked = userMapel && userMapel !== "ADMIN PUSAT";

                // Render Mapel hanya jika trigger init (dan tidak dikunci manual di luar) atau jika user ADMIN PUSAT
                if (triggerSource === 'init' && !isMapelLocked) renderOpts(fMapel, mapelSet, selMapel);
                
                // Jika Mapel terkunci, pastikan value tetap benar saat init
                if (triggerSource === 'init' && isMapelLocked) {
                    if(mapelSet.has(userMapel)) fMapel.value = userMapel;
                }

                if (triggerSource === 'mapel' || triggerSource === 'init') renderOpts(fKelas, kelasSet, selKelas, sortKelasRomawi);
                if (triggerSource === 'mapel' || triggerSource === 'kelas' || triggerSource === 'init') renderOpts(fBab, babSet, selBab);
                renderOpts(fSub, subSet, selSub);
            }

            // --- EVENT LISTENER TOMBOL BUKA MODAL (MODIFIED FOR LOCKING) ---
            document.getElementById('impor-bank-soal-btn').addEventListener('click', async () => {
                const modal = document.getElementById('impor-soal-modal');
                modal.classList.remove('hidden');
                
                document.getElementById('filter-results-container').innerHTML = '<div class="text-center text-gray-400 py-10">Memuat database cerdas...</div>';
                
                try {
                    const q = query(bankSoalCollectionRef);
                    const snap = await getDocs(q);
                    
                    cachedBankSoal = [];
                    snap.forEach(d => {
                        const data = d.data();
                        data.firebaseId = d.id;
                        cachedBankSoal.push(data);
                    });

                    // Init Dropdown Statis
                    const typeSel = document.getElementById('filter-tipe');
                    const levelSel = document.getElementById('filter-kesulitan');
                    typeSel.innerHTML = '<option value="">Semua Tipe</option>';
                    ['pg','pgk','bs','esai-singkat','esai-kompleks'].forEach(t => typeSel.add(new Option(t.toUpperCase(), t)));
                    levelSel.innerHTML = '<option value="">Semua Level</option>';
                    ['C1','C2','C3','C4','C5','C6'].forEach(l => levelSel.add(new Option(l, l)));

                    // --- RESET & LOCK LOGIC ---
                    ['filter-mapel', 'filter-kelas', 'filter-bab', 'filter-subbab'].forEach(id => {
                        document.getElementById(id).value = "";
                    });

                    // Cek Token Mapel
                    const userMapel = currentGuruMapel;
                    const mapelSelect = document.getElementById('filter-mapel');
                    
                    if (userMapel && userMapel !== "ADMIN PUSAT") {
                        // Kunci Mapel
                        mapelSelect.innerHTML = `<option value="${userMapel}">${userMapel}</option>`; // Pre-fill option
                        mapelSelect.value = userMapel;
                        mapelSelect.disabled = true; // User tidak bisa ganti
                        mapelSelect.classList.add('bg-gray-200', 'cursor-not-allowed');
                    } else {
                        // Buka Mapel
                        mapelSelect.disabled = false;
                        mapelSelect.classList.remove('bg-gray-200', 'cursor-not-allowed');
                    }
                    
                    updateSmartFilters('init'); 
                    document.getElementById('filter-results-container').innerHTML = '<div class="text-center text-gray-400 py-10">Silakan pilih filter untuk mencari soal.</div>';

                } catch (e) {
                    alert('Gagal memuat: ' + e.message);
                }
            });

            // --- EVENT LISTENER PERUBAHAN FILTER ---
            const fMapel = document.getElementById('filter-mapel');
            const fKelas = document.getElementById('filter-kelas');
            const fBab = document.getElementById('filter-bab');

            const newMapel = fMapel.cloneNode(true); fMapel.parentNode.replaceChild(newMapel, fMapel);
            const newKelas = fKelas.cloneNode(true); fKelas.parentNode.replaceChild(newKelas, fKelas);
            const newBab = fBab.cloneNode(true); fBab.parentNode.replaceChild(newBab, fBab);

            newMapel.addEventListener('change', () => updateSmartFilters('mapel'));
            newKelas.addEventListener('change', () => updateSmartFilters('kelas'));
            newBab.addEventListener('change', () => updateSmartFilters('bab'));
            
            document.getElementById('close-impor-modal-btn').addEventListener('click', () => document.getElementById('impor-soal-modal').classList.add('hidden'));
            document.getElementById('search-firebase-btn').addEventListener('click', performSearch);

            async function performSearch() {
                const container = document.getElementById('filter-results-container');
                container.innerHTML = '<div class="text-center py-4">Memuat...</div>';
                
                try {
                    const f = {
                        mapel: document.getElementById('filter-mapel').value,
                        kelas: document.getElementById('filter-kelas').value,
                        tipe: document.getElementById('filter-tipe').value,
                        kesulitan: document.getElementById('filter-kesulitan').value,
                        bab: document.getElementById('filter-bab').value,
                        subbab: document.getElementById('filter-subbab').value
                    };

                    const snap = await getDocs(query(bankSoalCollectionRef));
                    tempBankSoalResults = [];
                    container.innerHTML = '';

                    const promises = snap.docs.map(async (docSnap) => {
                        const d = docSnap.data();
                        d.firebaseId = docSnap.id;
                        
                        // Client side filtering
                        if(f.mapel && d.metadata?.mapel !== f.mapel) return null;
                        if(f.kelas && d.metadata?.kelas !== f.kelas) return null;
                        if(f.tipe && d.type !== f.tipe) return null;
                        if(f.kesulitan && d.metadata?.kesulitan !== f.kesulitan) return null;
                        if(f.bab && d.metadata?.bab !== f.bab) return null;
                        if(f.subbab && d.metadata?.subbab !== f.subbab) return null;

                        try {
                            const pk = await getDoc(doc(db, 'bank_soal_privat', d.firebaseId));
                            if(pk.exists()) d.kunci = pk.data().kunci;
                        } catch(e){}
                        return d;
                    });

                    const results = (await Promise.all(promises)).filter(Boolean);

                    if(results.length === 0) { container.innerHTML = '<div class="text-center text-gray-500">Tidak ditemukan soal dengan filter tersebut.</div>'; return; }

                    results.forEach(s => {
                        const item = document.createElement('div');
                        item.className = "p-3 bg-white dark:bg-cyber-800 border border-gray-200 dark:border-emerald-800 rounded-lg mb-2 flex items-start gap-3 cursor-pointer hover:shadow-md transition-all";
                        item.onclick = () => { 
                            const checkbox = item.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                        };
                        
                        item.innerHTML = `
                            <div class="pt-1"><input type="checkbox" class="import-checkbox w-4 h-4" data-id="${s.firebaseId}" onclick="event.stopPropagation()"></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800 dark:text-white line-clamp-2 mb-1">${s.naskah}</p>
                                
                                <div class="flex flex-wrap gap-2">
                                    <span class="px-2 py-0.5 rounded bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 text-[10px] font-bold border border-blue-200 dark:border-blue-800">
                                        ${(s.type||'?').toUpperCase()}
                                    </span>
                                    <span class="px-2 py-0.5 rounded bg-pink-100 text-pink-700 dark:bg-pink-900 dark:text-pink-300 text-[10px] font-bold border border-pink-200 dark:border-pink-800">
                                        ${s.metadata?.kesulitan || 'Level?'}
                                    </span>
                                    <span class="px-2 py-0.5 rounded bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 text-[10px] border border-gray-200 dark:border-gray-600">
                                        ${s.metadata?.bab || 'Bab?'}
                                    </span>
                                    
                                    ${s.metadata?.groupId ? `<span class="px-2 py-0.5 rounded bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 text-[10px] font-bold border border-purple-200 dark:border-purple-800 flex items-center gap-1" title="Soal Berkelompok"><span class="text-sm">üîó</span> ${s.metadata.groupId}</span>` : ''}
                                </div>
                            </div>
                            <button class="preview-btn p-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded border border-indigo-100" title="Preview">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </button>
                        `;
                        
                        item.querySelector('.preview-btn').onclick = (e) => {
                            e.stopPropagation();
                            openPreview(s);
                        };
                        
                        tempBankSoalResults.push(s);
                        container.appendChild(item);
                    });

                } catch(e) { container.innerHTML = '<div class="text-red-500 text-center">Error: '+e.message+'</div>'; }
            }

            document.getElementById('import-selected-btn').addEventListener('click', () => {
                const cbs = document.querySelectorAll('.import-checkbox:checked');
                cbs.forEach(cb => {
                    const s = tempBankSoalResults.find(x => x.firebaseId === cb.dataset.id);
                    if(s && !soalTerpilihUntukUjian.find(x => x.firebaseId === s.firebaseId)) {
                        const clone = JSON.parse(JSON.stringify(s));
                        clone.localSkor = 1;
                        soalTerpilihUntukUjian.push(clone);
                    }
                });
                renderSoalTerpilih();
                document.getElementById('impor-soal-modal').classList.add('hidden');
                showNotification(`${cbs.length} soal ditambahkan.`);
            });

            document.getElementById('select-all-btn').addEventListener('click', () => {
                document.querySelectorAll('.import-checkbox').forEach(cb => cb.checked = true);
            });

            window.renderSoalTerpilih = () => {
                const c = document.getElementById('soal-terpilih-container');
                const isAuto = document.getElementById('toggle-auto-bobot').checked;
                const count = soalTerpilihUntukUjian.length;
                
                document.getElementById('jumlah-soal-terpilih').textContent = count;
                
                if(isAuto && count > 0) {
                    const val = (100/count).toFixed(2);
                    soalTerpilihUntukUjian.forEach(s => s.localSkor = val);
                }

                const total = soalTerpilihUntukUjian.reduce((a,b) => a + parseFloat(b.localSkor||0), 0);
                document.getElementById('total-bobot-display').textContent = Math.round(total);

                if(count === 0) { c.innerHTML = '<div class="text-center text-gray-400 py-8 italic">Belum ada soal dipilih.</div>'; return; }

                c.innerHTML = '';
                soalTerpilihUntukUjian.forEach((s, i) => {
                    const inputState = isAuto ? 'disabled class="w-12 text-center bg-gray-100 text-gray-500 rounded font-bold text-xs p-1"' : 'class="w-full text-center text-sm font-bold bg-white dark:bg-cyber-900 border border-gray-200 dark:border-emerald-700 rounded px-1 py-1 text-indigo-600 dark:text-emerald-400 focus:outline-none focus:ring-1 focus:ring-indigo-500"';
                    
                    c.innerHTML += `
                        <div class="flex items-start gap-3 p-3 bg-white dark:bg-cyber-800 border border-gray-200 dark:border-emerald-800 rounded-xl shadow-sm group hover:shadow-md transition-all">
                            <span class="flex-none mt-1 w-6 h-6 rounded-full bg-indigo-50 dark:bg-emerald-900/30 text-indigo-600 dark:text-emerald-400 flex items-center justify-center text-xs font-bold">
                                ${i+1}
                            </span>

                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800 dark:text-white leading-relaxed mb-2 line-clamp-3">${s.naskah}</p>
                                
                                <div class="flex flex-wrap gap-1">
                                    <span class="px-1.5 py-0.5 rounded bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300 text-[10px] font-bold border border-blue-100 dark:border-blue-800">${(s.type||'?').toUpperCase()}</span>
                                    <span class="px-1.5 py-0.5 rounded bg-pink-50 text-pink-600 dark:bg-pink-900/30 dark:text-pink-300 text-[10px] border border-pink-100 dark:border-pink-800">${s.metadata?.kesulitan || 'Level?'}</span>
                                    <span class="px-1.5 py-0.5 rounded bg-gray-50 text-gray-600 dark:bg-gray-800 dark:text-gray-400 text-[10px] border border-gray-100 dark:border-gray-700">${s.metadata?.bab || 'Bab?'}</span>
                                    <span class="px-1.5 py-0.5 rounded bg-teal-50 text-teal-600 dark:bg-teal-900/30 dark:text-teal-300 text-[10px] border border-teal-100 dark:border-teal-800">${s.metadata?.subbab || 'Sub?'}</span>
                                </div>
                            </div>

                            <div class="flex-none w-28 bg-gray-50 dark:bg-black/20 rounded-lg border border-gray-100 dark:border-emerald-800/50 p-2 flex flex-col gap-2">
                                <div>
                                    <div class="text-[9px] text-center text-gray-400 uppercase font-bold mb-1">POIN</div>
                                    <input type="number" ${inputState} value="${s.localSkor}" onchange="updateBobot(${i}, this.value)">
                                </div>

                                <div class="flex justify-center gap-1 pt-1 border-t border-gray-200 dark:border-emerald-800/50">
                                    <button onclick="openPreviewFromSelected(${i})" class="p-1.5 text-blue-500 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded transition" title="Preview">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                    <button onclick="window.openDeepEdit(${i})" class="p-1.5 text-yellow-500 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded transition" title="Edit Full">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                    </button>
                                    <button onclick="removeSoal(${i})" class="p-1.5 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition" title="Hapus">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            };

            window.removeSoal = (i) => { soalTerpilihUntukUjian.splice(i, 1); renderSoalTerpilih(); };
            window.updateBobot = (i, v) => { soalTerpilihUntukUjian[i].localSkor = v; renderSoalTerpilih(); };
            
            window.openPreviewFromSelected = (i) => {
                const soal = soalTerpilihUntukUjian[i];
                if(soal) openPreview(soal);
            };

            // --- LOGIKA DEEP EDIT (CLONE & REPLACE) ---
            
            window.openDeepEdit = (index) => {
                const soal = soalTerpilihUntukUjian[index];
                if (!soal) return;

                document.getElementById('deep-edit-index').value = index;
                document.getElementById('deep-edit-type').value = soal.type;
                document.getElementById('deep-edit-naskah').value = soal.naskah;
                
                const btnAdd = document.getElementById('btn-add-deep-opt');
                if (soal.type.startsWith('esai')) btnAdd.classList.add('hidden');
                else btnAdd.classList.remove('hidden');

                renderDeepEditOptions(soal.type, soal.opsi, soal.kunci);
                
                document.getElementById('deep-edit-type').onchange = (e) => {
                    const newType = e.target.value;
                    let dummyOps = [];
                    
                    if (newType === 'pg') dummyOps = Array(5).fill({text:''});
                    else if (newType === 'pgk') dummyOps = Array(4).fill({text:''});
                    else if (newType === 'bs') dummyOps = Array(2).fill({text:''}); 
                    
                    if (newType.startsWith('esai')) btnAdd.classList.add('hidden');
                    else btnAdd.classList.remove('hidden');

                    renderDeepEditOptions(newType, dummyOps, null);
                };

                document.getElementById('deep-edit-modal').classList.remove('hidden');
            };

            window.addDeepEditOption = () => {
                const container = document.getElementById('deep-edit-options-list');
                const type = document.getElementById('deep-edit-type').value;
                const idx = container.children.length; 

                let inputType = type === 'pg' ? 'radio' : 'checkbox';
                let controlHtml = `<input type="${inputType}" name="deep-edit-key" class="w-5 h-5 text-indigo-600" value="${idx}">`;
                
                if (type === 'bs') {
                    controlHtml = `
                        <select class="deep-edit-bs-select p-1 border rounded text-xs bg-white dark:bg-black">
                            <option value="true">Benar</option>
                            <option value="false">Salah</option>
                        </select>
                    `;
                }

                const div = document.createElement('div');
                div.className = "flex items-center gap-2 mb-2";
                div.innerHTML = `
                    <div class="pt-1">${controlHtml}</div>
                    <input type="text" class="deep-edit-opt-text flex-1 p-2 border rounded bg-white dark:bg-black/20 dark:text-white text-sm" placeholder="Opsi/Pernyataan Baru">
                    <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-xs font-bold px-1">&times;</button>
                `;
                container.appendChild(div);
            };

            function renderDeepEditOptions(type, opsiArr, kunci) {
                const container = document.getElementById('deep-edit-options-list');
                container.innerHTML = '';

                if (type === 'esai-singkat') {
                    container.innerHTML = `
                        <input type="text" id="deep-edit-key-essay" class="w-full p-2 border rounded bg-white dark:bg-black/20 dark:text-white" placeholder="Kunci Jawaban Singkat" value="${kunci || ''}">
                    `;
                    return;
                }
                
                if (type === 'esai-kompleks') {
                    container.innerHTML = `<div class="text-sm text-gray-500">Soal uraian dinilai manual (tidak ada kunci otomatis).</div>`;
                    return;
                }

                (opsiArr || []).forEach((opt, idx) => {
                    let inputType = type === 'pg' ? 'radio' : 'checkbox';
                    let isChecked = false;
                    
                    if (type === 'pg') isChecked = (kunci == idx);
                    if (type === 'pgk') isChecked = Array.isArray(kunci) && kunci.includes(idx);
                    if (type === 'bs') isChecked = false;

                    let controlHtml = `<input type="${inputType}" name="deep-edit-key" class="w-5 h-5 text-indigo-600" value="${idx}" ${isChecked ? 'checked' : ''}>`;
                    
                    if (type === 'bs') {
                        const val = (kunci && kunci[idx]);
                        const isTrue = val === true || val === 'true';
                        controlHtml = `
                            <select class="deep-edit-bs-select p-1 border rounded text-xs bg-white dark:bg-black">
                                <option value="true" ${isTrue ? 'selected' : ''}>Benar</option>
                                <option value="false" ${!isTrue ? 'selected' : ''}>Salah</option>
                            </select>
                        `;
                    }

                    const div = document.createElement('div');
                    div.className = "flex items-center gap-2 mb-2";
                    div.innerHTML = `
                        <div class="pt-1">${controlHtml}</div>
                        <input type="text" class="deep-edit-opt-text flex-1 p-2 border rounded bg-white dark:bg-black/20 dark:text-white text-sm" value="${opt.text || ''}" placeholder="Opsi ${idx+1}">
                        <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-xs font-bold px-1">&times;</button>
                    `;
                    container.appendChild(div);
                });
            }

            window.saveDeepEdit = async (mode) => {
                const index = document.getElementById('deep-edit-index').value;
                const oldSoal = soalTerpilihUntukUjian[index];
                const type = document.getElementById('deep-edit-type').value;
                const naskah = document.getElementById('deep-edit-naskah').value;
                
                let newOpsi = [];
                let newKunci = null;

                if (type === 'pg') {
                    const texts = document.querySelectorAll('.deep-edit-opt-text');
                    const radios = document.querySelectorAll('input[name="deep-edit-key"]');
                    texts.forEach((el, i) => {
                        newOpsi.push({ text: el.value, imageBase64: oldSoal.opsi[i]?.imageBase64 || '' });
                        if (radios[i].checked) newKunci = i;
                    });
                } else if (type === 'pgk') {
                    const texts = document.querySelectorAll('.deep-edit-opt-text');
                    const checks = document.querySelectorAll('input[name="deep-edit-key"]');
                    newKunci = [];
                    texts.forEach((el, i) => {
                        newOpsi.push({ text: el.value, imageBase64: oldSoal.opsi[i]?.imageBase64 || '' });
                        if (checks[i].checked) newKunci.push(i);
                    });
                } else if (type === 'esai-singkat') {
                    newKunci = document.getElementById('deep-edit-key-essay').value;
                } else if (type === 'bs') {
                    const texts = document.querySelectorAll('.deep-edit-opt-text');
                    const selects = document.querySelectorAll('.deep-edit-bs-select');
                    newKunci = [];
                    texts.forEach((el, i) => {
                        newOpsi.push({ text: el.value, imageBase64: oldSoal.opsi[i]?.imageBase64 || '' });
                        newKunci.push(selects[i].value);
                    });
                }

                if (!naskah) return alert("Naskah wajib diisi");

                if (mode === 'update') {
                    if (!confirm("PERINGATAN: Anda akan mengubah soal asli di Bank Soal.\n\nJika ada ujian lain yang sedang menggunakan soal ini, naskahnya juga akan berubah.\n\nLanjutkan update?")) return;
                }

                const commonData = {
                    ...oldSoal,
                    naskah: naskah,
                    type: type,
                    opsi: newOpsi,
                    dibuatOleh: currentGuruId, // UPDATE KE ID GURU
                    tanggal: new Date().toISOString()
                };
                
                delete commonData.firebaseId;
                delete commonData.localSkor;
                delete commonData.kunci;

                const modal = document.getElementById('deep-edit-modal');
                const buttons = modal.querySelectorAll('button');
                buttons.forEach(b => b.disabled = true);

                try {
                    await runTransaction(db, async (transaction) => {
                        let targetId;
                        
                        if (mode === 'update') {
                            targetId = oldSoal.firebaseId;
                            const publicRef = doc(db, 'bank_soal', targetId);
                            const privatRef = doc(db, 'bank_soal_privat', targetId);
                            
                            transaction.set(publicRef, commonData); 
                            transaction.set(privatRef, { kunci: newKunci, tipe: type, updated: new Date().toISOString() });
                        } else {
                            const newDocRef = doc(collection(db, "bank_soal"));
                            targetId = newDocRef.id;
                            const newPrivRef = doc(db, "bank_soal_privat", targetId);
                            
                            commonData.asal = 'Cloned from Admin Ujian';
                            
                            transaction.set(newDocRef, commonData);
                            transaction.set(newPrivRef, { kunci: newKunci, tipe: type, updated: new Date().toISOString() });
                        }

                        const finalSoal = {
                            ...commonData,
                            firebaseId: targetId,
                            localSkor: oldSoal.localSkor,
                            kunci: newKunci
                        };

                        soalTerpilihUntukUjian[index] = finalSoal;
                    });

                    renderSoalTerpilih();
                    document.getElementById('deep-edit-modal').classList.add('hidden');
                    
                    if (mode === 'update') showNotification('Soal asli berhasil diperbarui (Live Update).');
                    else showNotification('Soal baru berhasil dibuat & diganti.');

                } catch (e) {
                    alert("Gagal simpan: " + e.message);
                } finally {
                    buttons.forEach(b => b.disabled = false);
                }
            };

            document.getElementById('setting-tampil-nilai').addEventListener('change', (e) => {
                const kunciContainer = document.getElementById('container-kunci');
                const kunciCheck = document.getElementById('setting-tampil-kunci');
                if(e.target.checked) {
                    kunciContainer.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    kunciContainer.classList.add('opacity-50', 'pointer-events-none');
                    kunciCheck.checked = false;
                }
            });

            document.getElementById('publish-exam-btn').addEventListener('click', async () => {
                if(soalTerpilihUntukUjian.length === 0) return alert('Pilih soal dulu!');
                
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                const bobotMap = {};
                soalTerpilihUntukUjian.forEach(s => bobotMap[s.firebaseId] = parseFloat(s.localSkor));

                const payload = {
                    kodeUjian: code,
                    namaUjian: document.getElementById('exam-name').value || 'Ujian Tanpa Judul',
                    targetKelas: document.getElementById('exam-target-class').value.split(',').map(s=>s.trim()),
                    targetSemuaKelas: document.getElementById('target-all-class').checked,
                    durasiMenit: parseInt(document.getElementById('exam-duration').value) || 60,
                    maxCurang: parseInt(document.getElementById('exam-max-cheat').value) || 3,
                    pinReset: document.getElementById('exam-pin-reset').value || '123456',
                    settingAcakSoal: document.getElementById('setting-acak-soal').checked,
                    settingAcakOpsi: document.getElementById('setting-acak-opsi').checked,
                    settingTampilNilai: document.getElementById('setting-tampil-nilai').checked,
                    // FIX: MENAMBAHKAN SETTING YANG HILANG
                    settingBatasiSatuKali: document.getElementById('setting-batasi-satu-kali').checked,
                    settingTampilKunci: document.getElementById('setting-tampil-kunci').checked,

					daftarIdSoal: soalTerpilihUntukUjian.map(s => s.firebaseId),
                    kustomisasiBobot: bobotMap,
                    status: 'aktif',
                    dibuatOleh: currentGuruId, // UPDATE FIXED: Menggunakan ID dari LocalStorage
                    mapel: currentGuruMapel,   // UPDATE FIXED: Menyimpan Mapel
                    tanggal: new Date().toISOString()
                };

                try {
                    await setDoc(doc(ujianTerjadwalCollectionRef, code), payload);
                    document.getElementById('exam-code-display').textContent = code;
                    document.getElementById('publish-success-modal').classList.remove('hidden');
                    soalTerpilihUntukUjian = [];
                    renderSoalTerpilih();
                } catch(e) { alert('Gagal publish: ' + e.message); }
            });

            // --- TAB 2: KELOLA ---
            document.getElementById('filter-kelola-kelas').addEventListener('change', () => {
                 renderActiveExams();
            });

            // UPDATE: Fetch logic with caching
            document.getElementById('fetch-active-exams-btn').addEventListener('click', async () => {
                const c = document.getElementById('active-exam-list');
                c.innerHTML = '<div class="text-center py-4">Loading...</div>';
                
                try {
                    let q = collection(db, 'ujian_terjadwal');
                    
                    // Filter berdasarkan ID Pembuat jika bukan Admin Pusat
                    if (currentGuruMapel !== 'ADMIN PUSAT' && currentGuruId) {
                         q = query(q, where('dibuatOleh', '==', currentGuruId));
                    }
                    
                    const snap = await getDocs(q);
                    
                    allActiveExams = []; // Reset cache
                    snap.forEach(d => {
                        allActiveExams.push({ id: d.id, ...d.data() });
                    });

                    // 1. Populate Filter Dropdown secara Otomatis
                    populateKelolaKelasFilter();

                    // 2. Render List
                    renderActiveExams();
                    
                } catch(e) { 
                    c.innerHTML = 'Error: '+e.message; 
                    console.error(e);
                }
            });

            function populateKelolaKelasFilter() {
                const select = document.getElementById('filter-kelola-kelas');
                // Simpan value lama jika ada, agar tidak reset saat refresh
                const oldVal = select.value; 

                // Ambil semua target kelas unik
                const classSet = new Set();
                allActiveExams.forEach(ex => {
                    if (ex.targetKelas && Array.isArray(ex.targetKelas)) {
                        ex.targetKelas.forEach(cls => classSet.add(cls));
                    }
                });

                // Urutkan
                const sortedClasses = Array.from(classSet).sort();

                // Reset options, keep "Semua Kelas"
                select.innerHTML = '<option value="">Semua Kelas</option>';
                sortedClasses.forEach(cls => {
                    select.add(new Option(cls, cls));
                });

                // Restore value jika masih valid
                if (sortedClasses.includes(oldVal)) {
                    select.value = oldVal;
                }
            }

            function renderActiveExams() {
                const c = document.getElementById('active-exam-list');
                const filterClass = document.getElementById('filter-kelola-kelas').value;

                c.innerHTML = '';

                // Filter Logic
                const filteredExams = allActiveExams.filter(ex => {
                    // Jika filter kosong, tampilkan semua
                    if (!filterClass) return true;
                    
                    // Jika ujian ini untuk "Semua Kelas", tampilkan juga (karena mencakup kelas yg dipilih)
                    if (ex.targetSemuaKelas) return true;

                    // Cek apakah array targetKelas mengandung kelas yang dipilih
                    return ex.targetKelas && ex.targetKelas.includes(filterClass);
                });

                if(filteredExams.length === 0) { 
                    c.innerHTML = '<div class="text-center text-gray-500">Tidak ada ujian yang sesuai filter.</div>'; 
                    return; 
                }

                filteredExams.forEach(ex => {
                    const isDraft = ex.status === 'draft';
                    
                    let statusBadge = '';
                    let borderClass = 'border-gray-200 dark:border-emerald-900';
                    let actionBtnClass = 'bg-blue-50 hover:bg-blue-100 text-blue-600 border-blue-100';
                    let actionBtnText = 'üìÑ DUPLIKASI';
                    
                    if (isDraft) {
                        statusBadge = `<span class="bg-orange-100 text-orange-700 border border-orange-200 px-2 py-1 rounded text-xs font-bold uppercase tracking-wide">DRAFT KATALOG</span>`;
                        borderClass = 'border-orange-300 dark:border-orange-800 ring-1 ring-orange-100';
                        actionBtnClass = 'bg-orange-500 hover:bg-orange-600 text-white shadow-md';
                        actionBtnText = '‚úèÔ∏è EDIT & PUBLISH';
                    } else {
                        statusBadge = ex.settingTampilNilai 
                            ? `<span class="bg-green-100 text-green-700 border border-green-200 px-2 py-1 rounded text-xs font-bold">NILAI: TAMPIL</span>` 
                            : `<span class="bg-yellow-100 text-yellow-700 border border-yellow-200 px-2 py-1 rounded text-xs font-bold">NILAI: SEMBUNYI</span>`;
                    }

                    const div = document.createElement('div');
                    div.className = `bg-white dark:bg-cyber-800 border ${borderClass} p-4 rounded-xl shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4 transition-all hover:shadow-md`;
                    
                    div.innerHTML = `
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-lg text-gray-800 dark:text-white">${ex.namaUjian}</h3>
                                <span class="text-[10px] px-2 py-0.5 rounded font-mono bg-indigo-100 text-indigo-700 font-bold border border-indigo-200 select-all">${ex.kodeUjian}</span>
                                ${isDraft ? '<span class="animate-pulse text-xs text-orange-500 font-bold ml-2">‚óè Perlu Finalisasi</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${ex.targetSemuaKelas ? 'Semua Kelas' : (ex.targetKelas || []).join(', ')} | ${ex.durasiMenit} Menit</p>
                        </div>
                        <div class="flex items-center gap-3">
                            ${statusBadge}

                            <button onclick="window.duplicateExam('${ex.id}')" class="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold border transition-colors ${actionBtnClass}" title="Duplikasi / Edit">
                                ${actionBtnText}
                            </button>
                            
                            <button onclick="window.toggleScoreVisibility('${ex.id}', ${ex.settingTampilNilai})" class="px-3 py-2 bg-gray-50 hover:bg-gray-100 text-gray-600 rounded-lg text-xs font-bold border border-gray-200 transition-all" title="Ubah Status Nilai">
                                üëÅÔ∏è
                            </button>
                            
                            <button onclick="window.deleteExam('${ex.id}')" class="p-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg border border-red-100 transition-colors" title="Hapus">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    c.appendChild(div);
                });
            }

            window.toggleScoreVisibility = async (id, currentVal) => {
                const newVal = !currentVal;
                try {
                    await updateDoc(doc(db, 'ujian_terjadwal', id), {
                        settingTampilNilai: newVal
                    });
                    
                    showNotification(`Status nilai berhasil diubah: ${newVal ? 'TAMPIL' : 'SEMBUNYI'}`);
                    
                    // Update cache local & re-render agar tidak perlu fetch ulang
                    const exam = allActiveExams.find(e => e.id === id);
                    if(exam) {
                        exam.settingTampilNilai = newVal;
                        renderActiveExams();
                    }
                } catch (e) {
                    alert('Gagal update status: ' + e.message);
                }
            };
            window.deleteExam = async (id) => {
                if(confirm('Hapus ujian ini? Data nilai siswa mungkin akan kehilangan referensi.')) {
                    await deleteDoc(doc(ujianTerjadwalCollectionRef, id));
                    // Hapus dari cache & re-render
                    allActiveExams = allActiveExams.filter(e => e.id !== id);
                    populateKelolaKelasFilter(); // Update filter karena mungkin kelasnya hilang
                    renderActiveExams();
                }
            };

            // Helper Preview Modal
            window.openPreview = (soal) => {
                const modal = document.getElementById('preview-soal-modal');
                const content = document.getElementById('preview-soal-content');
                
                let html = `<div class="text-base text-gray-800 dark:text-gray-100 leading-relaxed mb-4 font-medium">${soal.naskah}</div>`;
                if(soal.naskahImage) html += `<img src="${soal.naskahImage}" class="max-h-60 object-contain rounded border mx-auto mb-4">`;
                
                // Render Options & Key
                if(soal.type === 'pg' || soal.type === 'pgk') {
                    soal.opsi.forEach((o, i) => {
                        let isKey = false;
                        if (soal.kunci !== undefined) {
                            if (Array.isArray(soal.kunci)) isKey = soal.kunci.includes(i);
                            else isKey = (soal.kunci == i);
                        }
                        const cls = isKey ? 'border-green-500 bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-300 font-bold' : 'border-gray-200 text-gray-600 dark:text-gray-400';
                        html += `<div class="p-3 border rounded-lg mb-2 ${cls} flex items-center gap-3">
                            <span class="w-6 h-6 rounded flex items-center justify-center border text-xs">${String.fromCharCode(65+i)}</span>
                            <span>${o.text} ${isKey ? '‚úÖ' : ''}</span>
                        </div>`;
                    });
                } else if(soal.type === 'esai-singkat') {
                    html += `<div class="p-4 bg-green-50 border border-green-200 text-green-800 font-bold rounded-lg">Kunci: ${soal.kunci || '-'}</div>`;
                }
                
                content.innerHTML = html;
                modal.classList.remove('hidden');
                if(window.MathJax) MathJax.typesetPromise([content]);
            };

            // --- NEW: DUPLICATE / REUSE EXAM ---
            window.duplicateExam = async (examId) => {
                try {
                    // 1. Fetch Exam Data
                    const docSnap = await getDoc(doc(db, 'ujian_terjadwal', examId));
                    if (!docSnap.exists()) return alert('Data ujian tidak ditemukan');
                    const data = docSnap.data();

                    // 2. Fetch Questions (Parallel)
                    // Mengambil detail soal dari bank_soal berdasarkan ID
                    const questionPromises = data.daftarIdSoal.map(id => getDoc(doc(db, 'bank_soal', id)));
                    const questionSnaps = await Promise.all(questionPromises);
                    
                    const loadedQuestions = [];
                    questionSnaps.forEach(qSnap => {
                        if(qSnap.exists()) {
                            const qData = qSnap.data();
                            qData.firebaseId = qSnap.id;
                            // Restore bobot nilai
                            qData.localSkor = data.kustomisasiBobot?.[qSnap.id] || 1;
                            loadedQuestions.push(qData);
                        }
                    });

                    // 3. Populate Global State
                    soalTerpilihUntukUjian = loadedQuestions;
                    
                    // 4. Populate Form UI (SMART NAME LOGIC)
                    // --- BAGIAN INI YANG DIMODIFIKASI ---
                    if (data.status === 'draft') {
                        // Jika ini adalah draft dari katalog, hapus label "(Draft Katalog)" agar bersih
                        document.getElementById('exam-name').value = data.namaUjian.replace(' (Draft Katalog)', '');
                    } else {
                        // Jika ini duplikasi dari ujian yang sudah ada, tambahkan "(Copy)"
                        document.getElementById('exam-name').value = data.namaUjian + " (Copy)";
                    }
                    // ------------------------------------

                    document.getElementById('exam-target-class').value = data.targetKelas.join(', ');
                    document.getElementById('target-all-class').checked = data.targetSemuaKelas;
                    document.getElementById('exam-duration').value = data.durasiMenit;
                    document.getElementById('exam-max-cheat').value = data.maxCurang;
                    document.getElementById('exam-pin-reset').value = data.pinReset;
                    
                    // Checkboxes
                    document.getElementById('setting-acak-soal').checked = data.settingAcakSoal;
                    document.getElementById('setting-acak-opsi').checked = data.settingAcakOpsi;
                    // Cek undefined agar aman
                    document.getElementById('setting-batasi-satu-kali').checked = (data.settingBatasiSatuKali !== undefined) ? data.settingBatasiSatuKali : true;
                    
                    // Handle Score/Key Visibility Logic
                    const showScore = data.settingTampilNilai;
                    const scoreCheckbox = document.getElementById('setting-tampil-nilai');
                    scoreCheckbox.checked = showScore;
                    scoreCheckbox.dispatchEvent(new Event('change')); // Trigger event listener agar UI update
                    
                    document.getElementById('setting-tampil-kunci').checked = data.settingTampilKunci;

                    // 5. Update UI & Switch Tab
                    renderSoalTerpilih();
                    document.getElementById('tab-buat').click(); // Pindah otomatis ke Tab Buat Ujian
                    
                    showNotification('Data berhasil dimuat. Silakan finalisasi dan Publikasikan.');

                } catch (e) {
                    console.error(e);
                    alert('Gagal menduplikasi: ' + e.message);
                }
            }
        });
    </script>
</body>
</html>